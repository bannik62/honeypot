#!/bin/bash

# Script pour scanner les vulnÃ©rabilitÃ©s des interfaces web avec Nikto

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/../config/config"

if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
    export NIKTO_TUNING
    export NIKTO_TIMEOUT
else
    DATA_DIR="$SCRIPT_DIR/../data"
    NIKTO_PARALLEL=1
fi

if [ -z "$NIKTO_PARALLEL" ] || [ "$NIKTO_PARALLEL" -lt 1 ]; then
    NIKTO_PARALLEL=1
fi

if [ -z "$NIKTO_TIMEOUT" ] || [ "$NIKTO_TIMEOUT" -lt 60 ]; then
    NIKTO_TIMEOUT=600
fi

CSV_INPUT="$DATA_DIR/logs/web_interfaces.csv"
OUTPUT_DIR="$DATA_DIR/screenshots"

if [ ! -f "$CSV_INPUT" ]; then
    echo "âŒ Fichier CSV non trouvÃ©"
    exit 1
fi

if ! command -v nikto &> /dev/null; then
    echo "âŒ Nikto n'est pas installÃ©"
    exit 1
fi

echo "ðŸ” Scan de vulnÃ©rabilitÃ©s avec Nikto..."
echo "âš™ï¸  Processus parallÃ¨les: $NIKTO_PARALLEL"
echo "ðŸŽ¯ Tuning: ${NIKTO_TUNING:-tous les tests}"
echo ""

echo "ðŸ’¡ En cas de processus nikto restants aprÃ¨s arrÃªt, utilisez :"
echo "   pkill -9 -f \"nikto -h\""
echo "   pkill -9 -f \"timeout.*nikto\""
echo "   ps aux | grep -E \"vuln-scan|nikto\" | grep -v grep  # VÃ©rifier qu'il n'y a plus rien"
echo ""

# CrÃ©er la liste des URLs Ã  scanner
temp_file=$(mktemp)
tail -n +2 "$CSV_INPUT" | grep -v ",none," | while IFS=',' read -r timestamp ip port protocol url scanned; do
    if [ "$port" != "none" ] && [ -n "$url" ] && [ "$url" != "none" ]; then
        ip_dir="${OUTPUT_DIR}/${ip}"
        mkdir -p "$ip_dir"
        report_file="${ip_dir}/${ip}_${port}_nikto.txt"
        if [ ! -f "$report_file" ] || [ ! -s "$report_file" ]; then
            echo "${url}|${ip}|${port}"
        fi
    fi
done > "$temp_file"

total=$(wc -l < "$temp_file" 2>/dev/null || echo 0)

if [ "$total" -eq 0 ]; then
    echo "âœ… Tous les scans sont terminÃ©s"
    rm -f "$temp_file"
    exit 0
fi

# Scanner (sÃ©quentiel ou parallÃ¨le)
if [ "$NIKTO_PARALLEL" -eq 1 ]; then
    # Mode sÃ©quentiel
    count=0
    while IFS='|' read -r url ip port; do
        count=$((count + 1))
        echo "[$count/$total] ðŸ” Scan: $url"

        ip_dir="${OUTPUT_DIR}/${ip}"
        mkdir -p "$ip_dir"
        report_file="$ip_dir/${ip}_${port}_nikto.txt"

        timeout $NIKTO_TIMEOUT nikto -h "$url" -output "$report_file" -Format txt -timeout 2 ${NIKTO_TUNING:+-Tuning $NIKTO_TUNING} 2>/dev/null

        if [ $? -eq 0 ]; then
            echo "  âœ… TerminÃ©: $url"
        else
            echo "  âš ï¸  Ã‰chec: $url"
            # Supprimer le fichier s'il est vide (0 octet)
            if [ ! -f "$report_file" ] || [ ! -s "$report_file" ]; then
                echo "Scan failed: timeout or error" > "$report_file"
            fi
        fi
    done < "$temp_file"
else
    # Mode parallÃ¨le avec xargs
    cat "$temp_file" | xargs -P "$NIKTO_PARALLEL" -I {} bash -c '
        IFS="|" read -r url ip port <<< "$1"
        ip_dir="'"$OUTPUT_DIR"'/${ip}"
        mkdir -p "$ip_dir"
        report_file="$ip_dir/${ip}_${port}_nikto.txt"
        echo "ðŸ” Scan: $url"

        timeout '"$NIKTO_TIMEOUT"' nikto -h "$url" -output "$report_file" -Format txt -timeout 2 ${NIKTO_TUNING:+-Tuning $NIKTO_TUNING} 2>/dev/null

        if [ $? -eq 0 ]; then
            echo "  âœ… TerminÃ©: $url"
        else
            echo "  âš ï¸  Ã‰chec: $url"
            if [ ! -f "$report_file" ] || [ ! -s "$report_file" ]; then
                echo "Scan failed: timeout or error" > "$report_file"
            fi
        fi
    ' _ {}
fi

rm -f "$temp_file"
echo ""
echo "âœ… Scans terminÃ©s !"
